---
- name: "Update package cache"
  ansible.builtin.apt:
    update_cache: yes

- name: "Install required packages for Jenkins"
  ansible.builtin.apt:
    name:
      - openjdk-17-jdk
      - wget
      - gnupg
      - software-properties-common
    state: present

- name: "Add Jenkins GPG key"
  ansible.builtin.shell: |
    wget -q -O - https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key | apt-key add -
  args:
    creates: /etc/apt/trusted.gpg.d/jenkins.gpg

- name: "Add Jenkins repository"
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/jenkins.list
    content: "deb https://pkg.jenkins.io/debian-stable binary/"
    mode: '0644'

- name: "Update package cache after adding Jenkins repo"
  ansible.builtin.apt:
    update_cache: yes

- name: "Install Jenkins"
  ansible.builtin.apt:
    name: jenkins
    state: present

- name: "Start and enable Jenkins service"
  ansible.builtin.systemd:
    name: jenkins
    enabled: yes
    state: started

- name: "Wait for Jenkins to start"
  ansible.builtin.wait_for:
    port: 8080
    host: "{{ ansible_default_ipv4.address }}"
    delay: 10
    timeout: 60

- name: "Wait for Jenkins to be fully initialized"
  ansible.builtin.wait_for:
    path: /var/lib/jenkins/secrets/initialAdminPassword
    timeout: 120
    delay: 5

- name: "Get Jenkins initial admin password"
  ansible.builtin.shell: cat /var/lib/jenkins/secrets/initialAdminPassword
  register: jenkins_password
  changed_when: false
  failed_when: false

- name: "Get Jenkins initial admin password (alternative method)"
  ansible.builtin.shell: |
    if [ -f /var/lib/jenkins/secrets/initialAdminPassword ]; then
      cat /var/lib/jenkins/secrets/initialAdminPassword
    else
      echo "Jenkins not fully initialized yet. Please check Jenkins web interface."
    fi
  register: jenkins_password_alt
  changed_when: false
  when: jenkins_password.rc != 0

- name: "Display Jenkins initial admin password"
  ansible.builtin.debug:
    msg: |
      {% if jenkins_password.rc == 0 %}
      Jenkins initial admin password: {{ jenkins_password.stdout }}
      {% else %}
      {{ jenkins_password_alt.stdout }}
      Please wait for Jenkins to fully initialize and check the web interface.
      {% endif %}

- name: "Display Jenkins access information"
  ansible.builtin.debug:
    msg: |
      Jenkins is now running on: http://{{ ansible_default_ipv4.address }}:8080
      Initial admin password: {{ jenkins_password.stdout }}
      Please complete the setup wizard in your browser.

- name: "Install additional useful packages for Jenkins"
  ansible.builtin.apt:
    name:
      - git
      - curl
      - unzip
      - docker.io
      - ca-certificates
      - apt-transport-https
    state: present

- name: "Add Kubernetes GPG key"
  ansible.builtin.shell: |
    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  args:
    creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

- name: "Add Kubernetes repository"
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/kubernetes.list
    content: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /"
    mode: '0644'

- name: "Update package cache after adding Kubernetes repo"
  ansible.builtin.apt:
    update_cache: yes

- name: "Install kubectl"
  ansible.builtin.apt:
    name: kubectl
    state: present

- name: "Verify kubectl installation"
  ansible.builtin.command: kubectl version --client
  register: kubectl_version
  changed_when: false

- name: "Display kubectl version"
  ansible.builtin.debug:
    msg: "kubectl installed successfully: {{ kubectl_version.stdout_lines[0] }}"

- name: "Add jenkins user to docker group"
  ansible.builtin.user:
    name: jenkins
    groups: docker
    append: yes

- name: "Restart Jenkins to apply docker group changes"
  ansible.builtin.systemd:
    name: jenkins
    state: restarted 