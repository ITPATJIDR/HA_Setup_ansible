v---
  - name: "Check if Kubernetes is already initialized"
    ansible.builtin.stat:
      path: /etc/kubernetes/admin.conf
    register: k8s_admin_conf

  - name: "Reset existing Kubernetes cluster if exists"
    ansible.builtin.shell: |
      echo "Resetting existing Kubernetes cluster..."
      kubeadm reset -f
      rm -rf /etc/kubernetes/pki /etc/kubernetes/manifests /var/lib/etcd
      systemctl restart containerd
      echo "Kubernetes cluster reset completed"
    when: k8s_admin_conf.stat.exists
    ignore_errors: true

  - name: "Clean up any remaining Kubernetes files"
    ansible.builtin.file:
      path: "{{ item }}"
      state: absent
    loop:
      - /etc/kubernetes
      - /var/lib/etcd
      - /var/lib/kubelet
    ignore_errors: true

  - name: "Restart containerd service"
    ansible.builtin.systemd:
      name: containerd
      state: restarted

  - name: "Init First Master Node with HAProxy/Keepalived VIP"
    ansible.builtin.shell: "kubeadm init --control-plane-endpoint '{{ endpoint_lb }}:{{ control_plane_port }}' --upload-certs"
    register: init_output
  
  - name: "Create kubeconfig directory for admin user"
    ansible.builtin.shell: "mkdir -p {{ home_admin }}/.kube"

  - name: "Copy kubeconfig to admin user"
    ansible.builtin.shell: "cp /etc/kubernetes/admin.conf {{ home_admin }}/.kube/config"

  - name: "Set proper ownership for admin kubeconfig"
    ansible.builtin.shell: "chown $(id -u):$(id -g) {{ home_admin }}/.kube/config"

  - name: "Create kubeconfig directory for root user"
    ansible.builtin.shell: "mkdir -p /root/.kube"

  - name: "Copy kubeconfig to root user"
    ansible.builtin.shell: "cp /etc/kubernetes/admin.conf /root/.kube/config"

  - name: "Set proper ownership for root kubeconfig"
    ansible.builtin.shell: "chown root:root /root/.kube/config"
  
  - name: "Set Environment KUBECONFIG admin"
    ansible.builtin.lineinfile:
      path: "{{ home_admin }}/.bash_profile"
      line: "export KUBECONFIG={{ home_admin }}/.kube/config"
      state: present
      insertbefore: EOF 

  - name: "Set Environment KUBECONFIG root"
    ansible.builtin.lineinfile:
      path: "/root/.bash_profile"
      line: "export KUBECONFIG=/etc/kubernetes/admin.conf"
      state: present
      insertbefore: EOF 

  - name: "Approve kubelet-serving CSRs"
    ansible.builtin.shell: |
      for kubeletcsr in $(kubectl -n kube-system get csr | grep kubernetes.io/kubelet-serving | awk '{ print $1 }'); do
        kubectl certificate approve $kubeletcsr
      done

  - name: "Set key variable for join master node"
    ansible.builtin.set_fact:
      certficate_key: "{{ init_output.stdout_lines[39] }}"

  - name: "Print command join master"
    ansible.builtin.shell: kubeadm token create --print-join-command
    register: token_master
  
  - name: "Show join master"
    ansible.builtin.set_fact:
      join_node: "{{ token_master.stdout }}"

  - name: "Display join command for master nodes"
    ansible.builtin.debug:
      msg: "To join master nodes, use this command: {{ join_node }}"

  - name: "Display join command for worker nodes"
    ansible.builtin.shell: "kubeadm token create --print-join-command"
    register: token_worker
    ignore_errors: true

  - name: "Display worker join command"
    ansible.builtin.debug:
      msg: "To join worker nodes, use this command: {{ token_worker.stdout }}"